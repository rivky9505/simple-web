name: Run Book Fetcher

on:
  workflow_dispatch:
    inputs:
      query:
        description: 'Search query'
        required: false
        default: 'python'
      title_contains:
        description: 'Filter: title contains'
        required: false
        default: 'python'
      min_year:
        description: 'Filter: minimum publish year'
        required: false
        default: '2015'
      max_results:
        description: 'Maximum results to return'
        required: false
        default: '20'

jobs:
  fetch-books:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: python-book-fetcher
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run book fetcher with parameters
        run: |
          python book_fetcher.py \
            --query "${{ github.event.inputs.query }}" \
            --title-contains "${{ github.event.inputs.title_contains }}" \
            --min-year ${{ github.event.inputs.min_year }} \
            --max-results ${{ github.event.inputs.max_results }}

      - name: Show results
        run: |
          echo "=== Filtered Books ==="
          cat filtered_books.json
          echo ""
          echo "=== Summary ==="
          python -c "import json; d=json.load(open('filtered_books.json')); print(f'Total books: {len(d)}')"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: filtered-books-${{ github.event.inputs.query }}-${{ github.event.inputs.min_year }}
          path: python-book-fetcher/filtered_books.json
